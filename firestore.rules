/**
 * # Firestore Security Rules for Concurso Sprint
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership security model. All user-generated content, such as
 * simulated exams, flashcards, and study plans, is private and accessible only by the user who created it.
 * This ensures data privacy and isolation between users. A separate, global collection for questions
 * is made available for read-only access to all authenticated users.
 *
 * ## Data Structure
 * The data is organized hierarchically to reflect ownership. All user-specific data is nested within a
 * top-level `/users/{userId}` collection. This path-based ownership makes authorization checks simple
 * and performant. Publicly accessible data, like the question bank, resides in its own top-level
 * collection (`/questoes`) to segregate it from private user data.
 *
 * ## Key Security Decisions
 * - **Default Deny:** All access is denied by default. Rules explicitly grant permissions.
 * - **User Data Privacy:** Users can only access documents under their own `/users/{userId}` path.
 * - **No User Listing:** It is not possible for any client to list all documents in the `/users` collection.
 * - **Read-Only Public Data:** The `/questoes` collection is read-only for any signed-in user.
 *   This data is expected to be managed by a trusted backend or admin process, not by end-users.
 * - **Authorization Independence:** Rules rely on data within the document's path or its own fields for
 *   authorization. This avoids slow and costly `get()` or `exists()` calls to other documents.
 * - **Relational Integrity:** On creation, rules validate that the `userId` field inside a document
 *   matches the `userId` in the path, ensuring a consistent ownership link. This link is immutable
 *   and cannot be changed on update.
 *
 * ## Prototyping Mode
 * These rules are in "Prototyping Mode." They strictly enforce *authorization* (who can access what)
 * but are flexible on data *validation* (the shape of the data). This allows for rapid application
 * development without needing to update security rules for every schema change. Only fields critical for
 * authorization (like `userId`) are validated.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the given userId.
     * This is the primary function for enforcing user ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Validates that a user is creating a document in their own subcollection
     * and that the document's internal `userId` field correctly points to them.
     */
    function isCreatingOwnSubcollectionDoc(userId) {
      return isOwner(userId) && request.resource.data.userId == userId;
    }

    /**
     * Validates that a user is updating a document in their own subcollection
     * and that the ownership link (`userId` field) is not being changed.
     */
    function isUpdatingOwnSubcollectionDoc(userId) {
      return isOwner(userId) && request.resource.data.userId == resource.data.userId;
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to user profile documents and their private subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow get, update, delete: if isOwner(userId);
      allow create: if isOwner(userId);

      match /{subcollection}/{docId} {
        allow get, list: if isOwner(userId);
        allow create: if isCreatingOwnSubcollectionDoc(userId);
        allow update, delete: if isUpdatingOwnSubcollectionDoc(userId);
      }
    }

    /**
     * @description Controls access to the global, user-contributed question bank.
     * @path /questoes/{questaoId}
     * @allow (read) Any authenticated user can read questions.
     * @allow (create) Any authenticated user can add a question.
     * @allow (update, delete) Operations are denied for now for simplicity.
     * @principle Provides public read access for shared data, and controlled writes.
     */
    match /questoes/{questaoId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update, delete: if false; // Deny updates and deletes for now
    }
    
    /**
     * @description Controls access to the public community-contributed simulados.
     * @path /communitySimulados
     * @allow (list, get) Any authenticated user can read community simulados.
     * @allow (create) Any authenticated user can add a simulado.
     * @principle Provides public read access for shared data, and controlled writes.
     */
    match /communitySimulados/{simuladoId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
